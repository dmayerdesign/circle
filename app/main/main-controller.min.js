!function(e){angular.module("Circle").controller("mainController",["$scope","$rootScope","$state","$location","$http","init","customizer","action","$q","$filter","Upload",function(t,s,i,o,r,n,l,a,c,d,p){function u(){var t=function(t,s){t.each(function(){var t=e(this).outerHeight(!0);TweenMax.fromTo(e(this),.1,{y:500},{y:t,delay:1}),e(this).addClass("animation-initiated")}),s.each(function(){var t=e(this).outerWidth(!0);TweenMax.fromTo(e(this),.1,{x:-500},{x:-t,delay:1}),e(this).addClass("animation-initiated")})};t(e(".bottom-drawer"),e(".main-menu"));var s=function(){e("#post_type_regular").prop("checked",!0)};s()}function g(){var i=e(".post.not-treated");i.each(function(){function i(e,t){"photo"===t.type||"video"===t.type?t.src=t.url:t.src=t.thumbnail_url,s.archiveLinkPreviews[r.data("post-id")]=t,e.$apply()}var o,r=e(this),n=r.find("article"),l=(r.find(".post-inner"),n.html()),a=/(http|ftp|https):\/\/[\w-]+(\.[\w-]+)+([\w.,@?^=%&amp;:\/~+#-]*[\w@?^=%&amp;\/~+#-])?/,c=(new RegExp(a),a.exec(l));c?(o=c[0],l=l.split(o),l[0]+="<a href='"+o+"' target='_blank' title=''>"+o+"</a>",l[1]="",l=l.join(""),r.data("link-set")?i(t,r.data("link-set")):e.get("http://api.embed.ly/1/oembed?key=be2a929b1b694e8d8156be52cca95192&url="+o,function(e){i(t,e)})):(s.archiveLinkPreviews[r.data("post-id")]=null,t.$apply()),r.removeClass("not-treated"),n.html(l)})}if(s.currentState="main",localStorage.User){var f=JSON.parse(localStorage.User);f.email&&(t.user=f)}if(!t.user||!t.user._id)return void i.go("signup");t.loggedIn=!0,localStorage["Current-Circle"]?t.currentCircle=JSON.parse(localStorage["Current-Circle"])||{}:t.currentCircle=t.user.circles&&t.user.circles[0]||{},n.getUserAndCircle(t.user._id,t.currentCircle.accessCode,function(e,r){return t.user=e,t.user.isEmailVerified?void(r?(n.getMembers(r.accessCode,function(e){t.users=e}),t.circleJoined=!0,s.circleJoined=!0,t.circleName=r.name,t.circle=r,l.getStyle(t),n.getPosts(r._id,function(e){t.posts=e,t.postsAllowed={allow:20},setInterval(function(){t.incomingPosts=!1,n.getPosts(t.circle._id,function(e){t.incomingPosts=e,!t.incomingPosts||t.postsAreFiltered||t.postTypesAreFiltered||(t.difference=t.incomingPosts.length-t.posts.length,t.difference>0&&(t.posts=e))})},3e3),u()})):(t.circleJoined=!1,s.circleJoined=!1,i.go("createCircle"))):(console.log("email is not verified"),o.search().email&&o.search().verifyEmail&&(window.location.href="/#/verify-email?email="+o.search().email+"&verifyEmail="+o.search().verifyEmail),t.emailVerificationSent=!0,void i.go("signup"))}),t.postOrder="date",t.orderPosts=function(e){t.postOrder=e},t.newPost={content:"",tags:"",quest:{},images:[]},t.customSelect=function(t,s){var i=(e(t),this.newPost.tags),o=e(s.target),r=o.data("option"),n=(o.parents(".select"),o.hasClass("selected")),l=", ";return i&&i.indexOf(",")>-1&&(l=","),i&&i.indexOf(" ")>-1&&(l=" "),i&&i.indexOf(", ")>-1&&(l=", "),n?(o.removeClass("selected"),i=i&&i.indexOf(l)>-1?i&&i.replace(l+r,""):i&&i.replace(r,"")):(o.addClass("selected"),i&&i.length&&-1===i.indexOf(r)&&(i=i+l+r),i&&i.length||(i=r)),this.newPost.tags=i,console.log(i),i},t.upload=function(e){var i=this;e&&p.upload({url:"api/post/attachImage",method:"POST",data:{userId:t.user._id,circleId:s.currentCircle._id},file:e}).progress(function(e){console.log("uploading"),i.uploadInProgress=!0}).success(function(e){console.log(e.filePath),i.newPost.images.push(e.filePath),i.uploadInProgress=!1}).error(function(e){console.error(e),i.uploadInProgress=!1})},t.sendPost=function(i){if(!i||13===i.which){var o=this;if(!(o.newPost.content.length<=1)){(!o.newPost.tags||o.newPost.tags.length<=1)&&(o.newPost.tags="random"),$tags=o.newPost.tags;var n=$tags.indexOf(",")>-1?",":" ";n=$tags.indexOf(", ")>-1?", ":n;var l=$tags.split(n),a={},c=o.linkPreview,d={user:t.user.username||t.user.email,userId:t.user._id,avatar:t.user.avatar,circleId:t.circle._id,content:o.newPost.content,images:o.newPost.images,type:o.newPost.type,tags:l};if(c&&(a.url=c.url||c.thumbnail_url,a.thumbnail_url=c.thumbnail_url,a.title=c.title,a.description=c.description,a.provider_url=c.provider_url,a.type=c.type,d.linkEmbed=JSON.stringify(a)),"quest"===o.newPost.type&&o.newPost.quest&&o.newPost.quest.questers){var p=o.newPost.quest.questers,u=[];for(var g in p)u.push(g);d.quest={questers:u}}r.post("api/post/post",d).success(function(t){console.log(d),console.log(t),o.posts=t,o.newPost={},o.linkPreview=null,e("#new-post-area > *").blur()}).error(function(e){console.error(e)});for(var f=0;f<l.length;f++)r.post("api/tags/addTag",{name:l[f],circleId:t.circle._id}).then(function(e){e.data&&r.get("api/tags/getTags?circleId="+t.circle._id).then(function(e){for(var i=[],o=e.data,r=0;r<o.length;r++)o[r].hasOwnProperty("name")&&i.push(o[r].name);t.circle.tags=i,s.currentCircle.tags=i})})}}},t.setNewPosts=function(){t.posts=angular.copy(t.incomingPosts),t.incomingPosts=void 0},t.showPostsTagged=function(e){var s=this;n.getPosts(t.circle._id,function(i){return console.log(t.postsAreFiltered),t.posts=i,s.postsAllowed={allow:20},t.postsAreFiltered&&"undefined"!=typeof t.postsAreFiltered||(t.postsAreFiltered=!1),e&&"undefined"!=typeof e?(t.posts=d("filter")(t.posts,e),t.postsAreFiltered={filter:e},t.posts):(t.postsAreFiltered=!1,t.posts)})},t.showPostsOfType=function(e){var s=this;n.getPosts(t.circle._id,function(i){return console.log(t.postTypesAreFiltered),t.posts=i,s.postsAllowed={allow:20},t.postTypesAreFiltered&&"undefined"!=typeof t.postTypesAreFiltered||(t.postTypesAreFiltered=!1),e&&"undefined"!=typeof e?(t.posts=d("filter")(t.posts,e),t.postTypesAreFiltered={filter:e},t.posts):(t.postTypesAreFiltered=!1,t.posts)})},t.applyFilterClasses=function(){return t.postTypesAreFiltered&&t.postsAreFiltered?t.postTypesAreFiltered.filter+" "+t.postsAreFiltered.filter:t.postsAreFiltered?t.postsAreFiltered.filter:t.postTypesAreFiltered?t.postTypesAreFiltered.filter:void 0};var h=function(){var t=(e("head"),e(window).height()),s=e(".posts-archive-container");s.css({height:t+30+"px"}).addClass("initiated")},w=setInterval(function(){e(".posts-archive-container").hasClass("initiated")?clearInterval(w):(h(),e(window).resize(h))},200);t.showTagsDropdown=function(){t.tagsDropdownVisible=t.tagsDropdownVisible?!1:!0},t.resizeAvatar=function(t){var s=e(t);s.css({height:auto,width:auto});var i=s.width(),o=s.height(),r=s.parents(".avatar-container"),n={width:r.width(),height:r.height()};if(i>o)var l="height",a="top",c=n.height-o;else var l="width",a="left",c=n.width-i;var d={};d[l]=n[l],d["margin-"+a]=-c,s.css(d)},t.postsAllowed={allow:20},t.loadMore=function(){this.postsAllowed.allow+=20,console.log(this.postsAllowed)},t.generateLinkPreview=function(){var t,s=this,i=this.newPost.content,o=/(http|ftp|https):\/\/[\w-]+(\.[\w-]+)+([\w.,@?^=%&amp;:\/~+#-]*[\w@?^=%&amp;\/~+#-])?/,r=(new RegExp(o),o.exec(i));r?(t=r[0],console.log(t),e.get("http://api.embed.ly/1/oembed?key=be2a929b1b694e8d8156be52cca95192&url="+t,function(e){console.log(e.url),console.log(e.thumbnail_url),console.log(e),"photo"===e.type?e.src=e.url:e.src=e.thumbnail_url,s.linkPreview=e})):s.linkPreview=null},t.goToPost=function(e){console.log(window.location.href),i.go("single",{id:e})},s.archiveLinkPreviews={},setInterval(g,500)}])}(jQuery);